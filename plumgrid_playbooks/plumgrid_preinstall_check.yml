---
#
# Copyright (c) 2015, PLUMgrid Inc, http://plumgrid.com
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Pre-installation checks for PLUMgrid installation
- hosts: 127.0.0.1
  connection: local
  tasks:
    # Check for required Installation Files
    - name: Checking for License file existence
      stat:
        path: "{{ pg_license_path }}"
      register: lic_present
      failed_when: install_license == True and (lic_present.stat.exists == False or lic_present.stat.size == 0)
    - name: Checking for LCM key file
      stat:
        path: "{{ lvm_keypath_content }}"
      register: lcm_key_present
      failed_when: lcm_enabled is defined and lcm_enabled == True and (lcm_key_present.stat.exists == False  or lcm_key_present.stat.size == 0)
    - name: Add plumgrid installation into venv playbook
      lineinfile:
        dest: /opt/openstack-ansible/playbooks/roles/os_neutron/tasks/main.yml
        state: present
        line: "- include: post_neutron_plumgrid.yml"
    - name: Copy over post neutron tasks
      copy:
        src: post_neutron_plumgrid.yml
        dest: /opt/openstack-ansible/playbooks/roles/os_neutron/tasks/post_neutron_plumgrid.yml
    - name: Include LBaaS in user variables
      lineinfile:
        dest: /etc/openstack_deploy/user_variables.yml
        state: present
        line: "{{ item }}"
      with_items:
        - "neutron_plugin_base:"
        - "  - neutron_lbaas.services.loadbalancer.plugin.LoadBalancerPlugin"
      when: 
        - enable_lbaas is defined
        - enable_lbaas | bool
    - name: Add PG filters in LBaaS Haproxy filters file
      lineinfile:
        dest: /opt/openstack-ansible/playbooks/roles/os_neutron/files/rootwrap.d/lbaas-haproxy.filters
        state: present
        line: "{{ item }}"
      with_items:
        - "ifc_ctl: CommandFilter, /opt/pg/bin/ifc_ctl, root, ifc_ctl"
        - "ip: CommandFilter, ip, root, ip"
      when: 
        - enable_lbaas is defined
        - enable_lbaas | bool
    - name: Replace LBaaS interface driver with PLUMgrid LBaaS interface driver
      lineinfile:
        dest: /opt/openstack-ansible/playbooks/roles/os_neutron/templates/lbaas_agent.ini.j2
        backup: yes
        state: present
        regexp: "^interface_driver ="
        insertafter: "^interface_driver ="
        line: "interface_driver = plumgridlib.lbaas.interface_driver.PLUMgridInterfaceDriver"
      when: 
        - enable_lbaas is defined
        - enable_lbaas | bool
    - name: Download os-pg-version file from repo
      get_url:
        url: "{{ plumgrid_repo }}/files/pg_os_version.yaml"
        dest: /tmp/pg_os_version.yaml
        force: true
    - name: Download lvm-installer
      get_url:
        url: "{{ plumgrid_repo }}/files/lvm-installer.sh"
        dest: /tmp/lvm-installer.sh
        force: true
    - name: Extract PG version
      shell: >
        cat /tmp/lvm-installer.sh | grep pg_ver= | awk 'NR==1 {print}'| cut -c9-| sed 's/-.*//'
      register: pg_ver
    - name: Lookup networking-plumgrid version
      shell: >
        cat /tmp/pg_os_version.yaml | grep {{ pg_ver.stdout+'-l' }} | cut -d ' ' -f2
      register: os_ver
    - name: Remove pre-existing networking-plumgrid dict if exists
      lineinfile:
        dest: /etc/openstack_deploy/user_pg_vars.yml
        line: "neutron_optional_plumgrid_pip_packages:"
        state: absent
    - name: Remove pre-existing networking-plumgrid version if exists
      lineinfile:
        dest: /etc/openstack_deploy/user_pg_vars.yml
        regexp: ".- networking-plumgrid==."
        state: absent
    - name: Add networking-plumgrid version to vars
      lineinfile:
        dest: /etc/openstack_deploy/user_pg_vars.yml
        line: "\neutron_optional_plumgrid_pip_packages:\n  - networking-plumgrid=={{ os_ver.stdout }}"
        insertafter: 'switch_password: plumgrid'
        state: present

- name: Check Kernel Version
  hosts: shared-infra_hosts:compute_hosts:gateway_hosts
  user: root
  tasks:
    - name: Check Kernel Version
      fail:
        msg: >
          Unsupported kernel Version found
          [ {{ ansible_kernel }} > {{ required_pg_kernel }} ]
          Resolve this issue before continuing.
      when: required_pg_kernel is defined and (ansible_kernel | version_compare(required_pg_kernel, '>'))

- name: Check Pre-Install Requirements
  hosts: shared-infra_hosts
  user: root
  tasks:
    - name: Check if plumgrid is installed
      command: dpkg-query -l plumgrid-lxc
      register: deb_check
      ignore_errors: yes
    - name: Check that plumgrid designated ports are free
      wait_for: port={{ item.value }} state=absent timeout=10
      with_dict: pg_ports
      when: deb_check.stderr.find('no packages found') != -1
